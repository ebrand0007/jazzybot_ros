<?xml version="1.0"?>
<launch>

  <!--copied from linobot/bringup.launch /opt/ros/indigo/share/linorobot/launch/bringup.launch -->
  <!--serial communication between arduino and pc via usb /-->
  <node name="arduino_serial_node" pkg="rosserial_python" type="serial_node.py" output="screen">
    <param name="port" value="/dev/linobase" />
    <param name="baud" value="57600" />
  </node>



 <node pkg="ros_arduino_imu" type="raw_imu_bridge_node" name="raw_imu_bridge" output="screen" respawn="false">
   <rosparam>
   imu/gyroscope_bias: {x: -0.013545, y: 0.056887, z: 0.012693 }
   imu/accelerometer_bias: {x: -0.422578, y: 0.053516, z: -0.310391 }
    </rosparam>
   <param name="imu/perform_calibration" value="false" />
 </node>



  <node pkg="imu_filter_madgwick" type="imu_filter_node" name="imu_filter_madgwick" output="screen" respawn="false" >
    <!--param name="fixed_frame" value="odom" /-->
    <param name="fixed_frame" value="imu_baselink" />


    <param name="publish_debug_topics" value="true" />

  </node>

  <node name="lino_base_node" pkg="linorobot" type="lino_base_node">
    <remap from="/odom" to="lino_odom" />
  </node>



  <include file="$(find freenect_launch)/launch/freenect.launch">
     <arg name="depth_registration" value="true" />
  </include>


  <!--http://wiki.ros.org/rtabmap_ros#rtabmap_ros.2BAC8-data_throttle-->
  <!--Outputs to:
      <remap from="rgb/image" to="/camera/data_throttled_image"/>
      <remap from="depth/image" to="/camera/data_throttled_image_depth"/>
      <remap from="rgb/camera_info" to="/camera/data_throttled_camera_info"/>
  -->
  <!-- Use same nodelet used by Freenect/OpenNI -->
  <group ns="camera">
    <node pkg="nodelet" type="nodelet" name="data_throttle" args="load rtabmap_ros/data_throttle camera_nodelet_manager" output="screen">
      <param name="rate" type="double" value="5"/> <!--5 Htz-->
      <param name="decimation" type="int" value="1"/>  <!-- Reduce the image size, e.g., 2 means "width/2 x height/2". -->
      <!--TODO: Review other params, qyeue size and aprox_sync-->

      <remap from="rgb/image_in"       to="rgb/image_rect_color"/>
      <remap from="depth/image_in"     to="depth_registered/image_raw"/>
      <remap from="rgb/camera_info_in" to="rgb/camera_info"/>

      <remap from="rgb/image_out"       to="data_throttled_image"/>
      <remap from="depth/image_out"     to="data_throttled_image_depth"/>
      <remap from="rgb/camera_info_out" to="data_throttled_camera_info"/>

    </node>
  </group>

   <!--Voxel pointcloud throtteling-->
       <!--http://wiki.ros.org/pcl_ros/Tutorials/VoxelGrid%20filtering-->
       <!--http://wiki.ros.org/pcl_ros/Tutorials/filters#VoxelGrid-->
       <node pkg="nodelet" type="nodelet" name="pcl_manager" args="manager" output="screen" />

       <!-- Run a VoxelGrid filter to clean NaNs and downsample the data -->
       <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid pcl_manager" output="screen">
           <!--remap from="~input" to="/camera/depth/points" /-->
           <remap from="~input" to="camera/depth_registered/points" />
           <rosparam>
             filter_field_name: z
             filter_limit_min: 0.01
             filter_limit_max: 5.5
             filter_limit_negative: False
             leaf_size: 0.04 #0.01  Range: 0.0 to 1.0, smaller is more points
           </rosparam>
       </node>


  <!--set camera_link to base_link transforms-->
  <!--http://wiki.ros.org/tf#static_transform_publisher  -->
  <!-- Publish a static coordinate transform frame (tf) using an x/y/z offset in meters and yaw/pitch/roll in radians. 
                 Last arg is The period, in milliseconds, specifies how often to send a transform. 100ms (10hz) is a good value. -->
  <node pkg="tf" type="static_transform_publisher" name="base_link_to_camera_link" args=".381 0 .343 0 0 0 base_link camera_link 100"/>
  <node pkg="tf" type="static_transform_publisher" name="base_link_to_imu_base_link" args="-.381 0 .343 0 0 0 base_link imu_baselink 100"/>
  <!--node pkg="tf" type="static_transform_publisher" name="base_link_to_ekf_base_link" args="0 0 0 0 0 0 odom ekf_baselink 100"/-->

</launch>
