<?xml version="1.0"?>


<launch>  
  <!-- Localization-only mode -->
  <arg name="localization"      default="True"/>
  <arg name="rtabmap_args"  default="--delete_db_on_start"/>  

  <arg name="frame_id"                default="base_link" />


  <!--RGB (kinnect) topics>-->
  <!--UnThrottled - Uncoment one section-->
    <!--
    <arg name="rgb_topic"               default="/camera/rgb/image_rect_color" />
    <arg name="depth_topic"             default="/camera/depth_registered/image_raw" />
    <arg name="camera_info_topic"       default="/camera/rgb/camera_info" />
    <arg name="scan_cloud_topic"       default="/camera/depth_registered/points" />
    -->
  <!--Throtled-->
    <!-- -->
      <arg name="rgb_topic"               default="/camera/data_throttled_image"/>
      <arg name="depth_topic"             default="/camera/data_throttled_image_depth"/>
      <arg name="camera_info_topic"       default="/camera/data_throttled_camera_info"/>
      <arg name="scan_cloud_topic"        default="/voxel_grid/output" />
    <!-- -->

  <!-- stereo related topics -->
  <arg name="stereo_namespace"        default="/stereo_camera"/>
  <arg name="left_image_topic"        default="$(arg stereo_namespace)/left/image_rect_color" />
  <arg name="right_image_topic"       default="$(arg stereo_namespace)/right/image_rect" />      
       <!-- using grayscale image above for efficiency -->
  <arg name="left_camera_info_topic"  default="$(arg stereo_namespace)/left/camera_info" />
  <arg name="right_camera_info_topic" default="$(arg stereo_namespace)/right/camera_info" />


  
  <group ns="rtabmap">
    <!-- Visual Odometry https://github.com/introlab/rtabmap_ros/blob/master/launch/tests/sensor_fusion.launch-->
    <node pkg="rtabmap_ros" type="rgbd_odometry" name="visual_odometry" output="screen" args="$(arg rtabmap_args)"> <!--uinfo--> <!--udebug-->
      <remap from="rgb/image"       to="$(arg rgb_topic)"/>
      <remap from="depth/image"     to="$(arg depth_topic)"/>
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
      <remap from="odom"            to="/vo"/>

      <!--from  default rtabmap launch-->
      <!--param name="frame_id"             type="string" value="camera_link"/-->
      <param name="frame_id"               type="string" value="$(arg frame_id)"/>
      <param name="publish_tf"             type="bool"   value="false"/>
      <param name="publish_null_when_lost" type="bool"   value="true"/>
      <param name="guess_from_tf"          type="bool"   value="true"/>
      <param name="wait_for_transform_duration" type="double" value="0.2"/>
      <param name="approx_sync"                 type="bool"   value="true"/>
      <param name="config_path"                 type="string" value=""/>

      <!--tuning-->
      <!--TODO: resarch these-->
      <param name="Odom/FillInfoData"      type="string" value="true"/>
      <param name="Odom/ResetCountdown"    type="string" value="1"/>
      <param name="Vis/FeatureType"        type="string" value="6"/> 
      <param name="queue_size"                  type="int" value="10"/>
          <!-- To change RTAB-Map's parameters, the path of config_path file (*.ini) generated by the standalone app -->

      <!--tuning http://wiki.ros.org/rtabmap_ros/Tutorials/Advanced%20Parameter%20Tuning#Visual_Odometry-->
      <!-- Correspondences: 0=Features Matching, 1=Optical Flow -->
      <param name="Odom/Strategy" value="1"/>
      <!-- maximum features map size, default 2000 -->
      <param name="OdomF2M/MaxSize" type="string" value="1000"/> 
      <!-- maximum features extracted by image, default 1000 -->
      <param name="Vis/MaxFeatures" type="string" value="600"/>


    </node>


    <!-- SLAM -->
    <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="$(arg rtabmap_args)">
      <param name="frame_id"        type="string" value="$(arg frame_id)"/>
      <!--param name="frame_id"             type="string" value="camera_link"/-->
 
      <remap from="rgb/image"       to="$(arg rgb_topic)"/>
      <remap from="depth/image"     to="$(arg depth_topic)"/>
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
      <remap from="odom"            to="/odometry/filtered"/>
      <!--remap from="odom"            to="/odom"/-->
      <remap from="scan"             to="/scan"/>
      
      <param name="odom_frame_id" type="string" value="/odom"/>
      <!--param name="odom_topic" value="/odometry/filtered"/-->

      <param name="subscribe_scan_cloud" type="bool"   value="false"/>
      <!--param name="scan_cloud_topic"  value="$(arg scan_cloud_topic) --> <!--scan_cloud toic(pointclund2 -->
      <param name="subscribe_scan" type="bool" value="true"/>
      <!--param name="scan_topic" value="/scan"/-->  <!--laser scan topic-->
      <param name="subscribe_depth" type="bool" value="true"/>


     


      <param name="wait_for_transform_duration"  type="double"   value="0.2"/>
      <param name="database_path"        type="string" value="~/.ros/rtabmap.db"/>
      <param name="approx_sync"          type="bool"   value="true"/>
      <param name="config_path"          type="string" value=""/>
          <!-- To change RTAB-Map's parameters, the path of config_path file (*.ini) generated by the standalone app -->
      <param name="queue_size"           type="int" value="10"/>
      
      <!--param name="Kp/DetectorStrategy"    type="string" value="6"/--> <!-- use same features as odom -->

      <!-- localization mode -->
      <!--Mem/IncrementalMemory=False-->
      <param name="Mem/InitWMWithAllNodes" type="string" value="True"/> 
      <param name="Mem/IncrementalMemory" type="string" value="true"/>

      <!--TODO: test param name="grid_unknown_space_filled" type="bool"   value="true"/-->
      
    </node>
  </group>
</launch>
